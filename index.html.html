<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fiches JDR - T√©l√©chargements</title>

    <!-- Import de la police HamletOrNot -->
    <style>
        @font-face {
            font-family: 'HamletOrNot';
            src: url('assets/HamletOrNot.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'HamletOrNot', serif;
            margin: 0;
            padding: 0;
            background-image: url('assets/un-groupe-d-aventuriers-fantastiques.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #fff;
            text-shadow: 1px 1px 2px black;
        }

        .content {
            background: rgba(0, 0, 0, 0.55);
            padding: 20px;
            margin: 40px auto;
            width: 80%;
            max-width: 900px;
            border-radius: 15px;
            border: 2px solid #000;
        }

        h1 {
            text-align: center;
            font-size: 3rem;
            margin-bottom: 25px;
        }

        .file-block {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #000;
            margin-bottom: 25px;
        }

        .file-title {
            font-size: 1.7rem;
            margin-bottom: 10px;
        }

        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid #000;
            padding: 10px 18px;
            border-radius: 8px;
            text-decoration: none;
            color: white;
            font-size: 1.2rem;
            transition: 0.2s;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-row label {
            min-width: 140px;
        }

        .form-row input,
        .form-row select {
            flex: 1;
            min-width: 160px;
            border-radius: 6px;
            border: 1px solid #000;
            padding: 4px 8px;
            font-family: 'HamletOrNot', serif;
        }

        .subsection-title {
            font-size: 1.3rem;
            margin: 10px 0 6px;
            font-weight: bold;
        }
    
        /* Banque d'images personnage */
        .image-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 4px;
        }

        .image-option {
            border: 1px solid #000;
            border-radius: 6px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.5);
            cursor: pointer;
            max-width: 90px;
            text-align: center;
        }

        .image-option img {
            display: block;
            width: 100%;
            border-radius: 4px;
        }

        .image-option .image-caption {
            font-size: 0.7rem;
            margin-top: 2px;
        }

        .image-option a {
            display: block;
            font-size: 0.7rem;
            margin-top: 2px;
            color: #f5d36b;
            text-decoration: none;
        }

        .image-option a:hover {
            text-decoration: underline;
        }

        .image-option.selected {
            outline: 2px solid #f5d36b;
            box-shadow: 0 0 6px rgba(245, 211, 107, 0.8);
        }
</style>
</head>

<body>
    <div class="content">
        <h1>Fiches de Personnages - T√©l√©chargement & Acc√®s</h1>

        <!-- Fiche AVEC passeport - ESCLAVE -->
        <div class="file-block">
            <div class="file-title">üìú Fiche personnage (avec passeport - esclave)</div>

            <div class="buttons">
                <a class="btn" href="fiches/fiche_personnage_modele_avec_passeport_esclave.html" download>
                    ‚¨áÔ∏è T√©l√©charger
                </a>

                <a class="btn" href="fiches/fiche_personnage_modele_avec_passeport_esclave.html" target="_blank">
                    üåê Ouvrir dans le navigateur
                </a>
            </div>
        </div>

        <!-- Fiche AVEC passeport - MA√éTRE -->
        <div class="file-block">
            <div class="file-title">üìú Fiche personnage (avec passeport - ma√Ætre)</div>

            <div class="buttons">
                <a class="btn" href="fiches/fiche_personnage_modele_avec_passeport_maitre.html" download>
                    ‚¨áÔ∏è T√©l√©charger
                </a>

                <a class="btn" href="fiches/fiche_personnage_modele_avec_passeport_maitre.html" target="_blank">
                    üåê Ouvrir dans le navigateur
                </a>
            </div>
        </div>

        <!-- Fiche SANS passeport -->
        <div class="file-block">
            <div class="file-title">üìú Fiche personnage (sans passeport)</div>

            <div class="buttons">
                <a class="btn" href="fiches/fiche_personnage_modele_sans_passeport.html" download>
                    ‚¨áÔ∏è T√©l√©charger
                </a>

                <a class="btn" href="fiches/fiche_personnage_modele_sans_passeport.html" target="_blank">
                    üåê Ouvrir dans le navigateur
                </a>
            </div>
        </div>

        <!-- CR√âER UNE FICHE PR√â-REMPLIE -->
        <div class="file-block">
            <div class="file-title">üß© Cr√©er une fiche pr√©-remplie</div>

            <div class="form-row">
                <label for="fiche_type">Type de fiche :</label>
                <select id="fiche_type" onchange="updateZones()">
                    <option value="sans">Sans passeport</option>
                    <option value="esclave">Passeport esclave</option>
                    <option value="maitre">Passeport ma√Ætre</option>
                </select>
            </div>

            <div class="subsection-title">Identit√©</div>
            <div class="form-row">
                <label for="in_prenom">Pr√©nom :</label>
                <input type="text" id="in_prenom" />
            </div>
            <div class="form-row">
                <label for="in_nom">Nom :</label>
                <input type="text" id="in_nom" />
            </div>
            <div class="form-row">
                <label for="in_age">√Çge :</label>
                <input type="text" id="in_age" />
            </div>
            <div class="form-row">
                <label for="in_race">Race :</label>
                <input type="text" id="in_race" />
            </div>

            <div class="subsection-title">Personnage</div>

            <div class="form-row">
                <label for="image_race_select">Race :</label>
                <select id="image_race_select">
                    <option value="">-- Choisir une race --</option>
                    <option value="beast">Beast</option>
                </select>
            </div>

            <div class="form-row">
                <label for="image_age_select">√Çge :</label>
                <select id="image_age_select">
                    <option value="">-- Choisir une tranche d'√¢ge --</option>
                    <option value="adolescent">Adolescent</option>
                    <option value="adulte">Adulte</option>
                </select>
            </div>

            <div class="form-row">
                <label>Image :</label>
                <div class="image-bank" id="image_bank">
                    <!-- Banque d'images - Beast adolescent -->
                    <div class="image-option" data-race="beast" data-age="adolescent" data-img="assets/banque/grenouille_baton.png">
                        <img src="assets/banque/grenouille_baton.png" alt="Beast grenouille avec b√¢ton" />
                        <div class="image-caption">Grenouille (b√¢ton)</div>
                        <a href="assets/banque/grenouille_baton.png" download class="image-download">>T√©l√©charger</a>
                    </div>
                    <div class="image-option" data-race="beast" data-age="adolescent" data-img="assets/banque/grenouille_massue.png">
                        <img src="assets/banque/grenouille_massue.png" alt="Beast grenouille avec massue" />
                        <div class="image-caption">Grenouille (massue)</div>
                        <a href="assets/banque/grenouille_massue.png" download class="image-download">>T√©l√©charger</a>
                    </div>
                    <div class="image-option" data-race="beast" data-age="adolescent" data-img="assets/banque/lezard_epee.png">
                        <img src="assets/banque/lezard_epee.png" alt="Beast l√©zard avec √©p√©e" />
                        <div class="image-caption">L√©zard (√©p√©e)</div>
                        <a href="assets/banque/lezard_epee.png" download class="image-download">>T√©l√©charger</a>
                    </div>
                    <div class="image-option" data-race="beast" data-age="adolescent" data-img="assets/banque/lezarde-baton.png">
                        <img src="assets/banque/lezarde-baton.png" alt="Beast l√©zarde avec b√¢ton" />
                        <div class="image-caption">L√©zarde (b√¢ton)</div>
                        <a href="assets/banque/lezarde-baton.png" download class="image-download">>T√©l√©charger</a>
                    </div>
                    <div class="image-option" data-race="beast" data-age="adolescent" data-img="assets/banque/lion_epee.png">
                        <img src="assets/banque/lion_epee.png" alt="Beast lion avec √©p√©e" />
                        <div class="image-caption">Lion (√©p√©e)</div>
                        <a href="assets/banque/lion_epee.png" download class="image-download">>T√©l√©charger</a>
                    </div>
                    <div class="image-option" data-race="beast" data-age="adolescent" data-img="assets/banque/lionne_magie.png">
                        <img src="assets/banque/lionne_magie.png" alt="Beast lionne avec magie" />
                        <div class="image-caption">Lionne (magie)</div>
                        <a href="assets/banque/lionne_magie.png" download class="image-download">>T√©l√©charger</a>
                    </div>
                    <div class="image-option" data-race="beast" data-age="adolescent" data-img="assets/banque/loup_epee.png">
                        <img src="assets/banque/loup_epee.png" alt="Beast loup avec √©p√©e" />
                        <div class="image-caption">Loup (√©p√©e)</div>
                        <a href="assets/banque/loup_epee.png" download class="image-download">>T√©l√©charger</a>
                    </div>
                    <div class="image-option" data-race="beast" data-age="adolescent" data-img="assets/banque/louve_magie.png">
                        <img src="assets/banque/louve_magie.png" alt="Beast louve avec magie" />
                        <div class="image-caption">Louve (magie)</div>
                        <a href="assets/banque/louve_magie.png" download class="image-download">>T√©l√©charger</a>
                    </div>
                    <div class="image-option" data-race="beast" data-age="adolescent" data-img="assets/banque/ours_hache.png">
                        <img src="assets/banque/ours_hache.png" alt="Beast ours avec hache" />
                        <div class="image-caption">Ours (hache)</div>
                        <a href="assets/banque/ours_hache.png" download class="image-download">>T√©l√©charger</a>
                    </div>
                    <div class="image-option" data-race="beast" data-age="adolescent" data-img="assets/banque/ourse_potion.png">
                        <img src="assets/banque/ourse_potion.png" alt="Beast ourse avec potions" />
                        <div class="image-caption">Ourse (potions)</div>
                        <a href="assets/banque/ourse_potion.png" download class="image-download">>T√©l√©charger</a>
                    </div>
                </div>
            </div>

            <input type="hidden" id="in_image_url" />

            <!-- Zone passeport ESCLAVE -->
            <div id="zone_passport_esclave" style="display:none; margin-top: 10px;">
                <div class="subsection-title">Passeport (esclave)</div>

                <div class="form-row">
                    <label for="in_p_nom">Nom attribu√© :</label>
                    <input type="text" id="in_p_nom" placeholder="Nom attribu√© √† l'esclave..." />
                </div>
                <div class="form-row">
                    <label for="in_p_race">Race / Type :</label>
                    <input type="text" id="in_p_race" placeholder="Race (renard, l√©zard...) / Type (canid√©, reptile...)" />
                </div>
                <div class="form-row">
                    <label for="in_p_age">√Çge estim√© :</label>
                    <input type="text" id="in_p_age" placeholder="√Çge estim√© du Beast..." />
                </div>
                <div class="form-row">
                    <label for="in_p_sexe">Sexe :</label>
                    <input type="text" id="in_p_sexe" placeholder="M√¢le, Femelle..." />
                </div>
                <div class="form-row">
                    <label for="in_p_statut">Statut :</label>
                    <input type="text" id="in_p_statut" placeholder="Esclave enregistr√©, libre..." />
                </div>
                <div class="form-row">
                    <label for="in_p_owner">Propri√©taire actuel :</label>
                    <input type="text" id="in_p_owner" placeholder="Nom du propri√©taire du Beast..." />
                </div>
                <div class="form-row">
                    <label for="in_p_date">Date d'enregistrement :</label>
                    <input type="text" id="in_p_date" placeholder="Date d'enregistrement de l'esclave..." />
                </div>
            </div>

            <!-- Zone passeport MA√éTRE -->
            <div id="zone_passport_maitre" style="display:none; margin-top: 10px;">
                <div class="subsection-title">Passeport (ma√Ætre)</div>

                <div class="form-row">
                    <label for="in_m_nom">Nom du ma√Ætre :</label>
                    <input type="text" id="in_m_nom" placeholder="Nom du personnage.." />
                </div>
                <div class="form-row">
                    <label for="in_m_race">Race / Type :</label>
                    <input type="text" id="in_m_race" placeholder="Race du Beast / Esp√®ce du Beast.." />
                </div>
                <div class="form-row">
                    <label for="in_m_statut">Statut :</label>
                    <input type="text" id="in_m_statut" placeholder="Propri√©taire enregistr√©, Propri√©taire temporaire.." />
                </div>
                <div class="form-row">
                    <label for="in_m_sujet">Sujet assign√© :</label>
                    <input type="text" id="in_m_sujet" placeholder="Nom de l'esclave.." />
                </div>
                <div class="form-row">
                    <label for="in_m_date">Date d'Enregistrement :</label>
                    <input type="text" id="in_m_date" placeholder="Date d'enregistrement de l'esclave.." />
                </div>
            </div>

            <div class="buttons" style="margin-top: 15px;">
                <button class="btn" type="button" onclick="ouvrirFiche()">üåê Ouvrir la fiche pr√©-remplie</button>
            </div>
        </div>
    </div>

    <script>
        function updateZones() {
            const type = document.getElementById('fiche_type').value;
            const zoneEsclave = document.getElementById('zone_passport_esclave');
            const zoneMaitre = document.getElementById('zone_passport_maitre');

            zoneEsclave.style.display = (type === 'esclave') ? 'block' : 'none';
            zoneMaitre.style.display  = (type === 'maitre')  ? 'block' : 'none';
        }

        function ouvrirFiche() {
            const type  = document.getElementById('fiche_type').value;

            const prenom = encodeURIComponent(document.getElementById('in_prenom').value || '');
            const nom    = encodeURIComponent(document.getElementById('in_nom').value || '');
            const age    = encodeURIComponent(document.getElementById('in_age').value || '');
            const race   = encodeURIComponent(document.getElementById('in_race').value || '');
            const portrait = encodeURIComponent(document.getElementById('in_image_url').value || '');

            let url = '';

            if (type === 'sans') {
                url = 'fiches/fiche_personnage_modele_sans_passeport.html'
                    + `?prenom=${prenom}&nom=${nom}&age=${age}&race=${race}&portrait=${portrait}`;
            } else if (type === 'esclave') {
                const p_nom    = encodeURIComponent(document.getElementById('in_p_nom').value || '');
                const p_race   = encodeURIComponent(document.getElementById('in_p_race').value || '');
                const p_age    = encodeURIComponent(document.getElementById('in_p_age').value || '');
                const p_sexe   = encodeURIComponent(document.getElementById('in_p_sexe').value || '');
                const p_statut = encodeURIComponent(document.getElementById('in_p_statut').value || '');
                const p_owner  = encodeURIComponent(document.getElementById('in_p_owner').value || '');
                const p_date   = encodeURIComponent(document.getElementById('in_p_date').value || '');

                url = 'fiches/fiche_personnage_modele_avec_passeport_esclave.html'
                    + `?prenom=${prenom}&nom=${nom}&age=${age}&race=${race}`
                    + `&p_nom=${p_nom}&p_race=${p_race}&p_age=${p_age}&p_sexe=${p_sexe}`
                    + `&p_statut=${p_statut}&p_owner=${p_owner}&p_date=${p_date}`;
            } else if (type === 'maitre') {
                const m_nom    = encodeURIComponent(document.getElementById('in_m_nom').value || '');
                const m_race   = encodeURIComponent(document.getElementById('in_m_race').value || '');
                const m_statut = encodeURIComponent(document.getElementById('in_m_statut').value || '');
                const m_sujet  = encodeURIComponent(document.getElementById('in_m_sujet').value || '');
                const m_date   = encodeURIComponent(document.getElementById('in_m_date').value || '');

                url = 'fiches/fiche_personnage_modele_avec_passeport_maitre.html'
                    + `?prenom=${prenom}&nom=${nom}&age=${age}&race=${race}&portrait=${portrait}`
                    + `&m_nom=${m_nom}&m_race=${m_race}`
                    + `&m_statut=${m_statut}&m_sujet=${m_sujet}&m_date=${m_date}`;
            }

            if (url) {
                window.open(url, '_blank');
            }
        }

        function initImageBank() {
            const imageOptions = document.querySelectorAll('.image-option');
            const hidden = document.getElementById('in_image_url');
            const raceSelect = document.getElementById('image_race_select');
            const ageSelect  = document.getElementById('image_age_select');

            if (!hidden || imageOptions.length === 0) return;

            function applyFilter() {
                const race = raceSelect ? raceSelect.value : '';
                const age  = ageSelect ? ageSelect.value : '';

                imageOptions.forEach((opt) => {
                    const optRace = opt.getAttribute('data-race') || '';
                    const optAge  = opt.getAttribute('data-age') || '';

                    // Par d√©faut : on exige que race ET √¢ge soient choisis pour afficher les images
                    const match = race && age && optRace === race && optAge === age;
                    opt.style.display = match ? '' : 'none';

                    // Si l'option s√©lectionn√©e n'est plus visible, on nettoie la s√©lection
                    if (opt.classList.contains('selected') && !match) {
                        opt.classList.remove('selected');
                        hidden.value = '';
                    }
                });
            }

            imageOptions.forEach((opt) => {
                opt.addEventListener('click', function () {
                    if (this.style.display === 'none') return; // on ignore les options masqu√©es
                    imageOptions.forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    hidden.value = this.getAttribute('data-img') || '';
                });
            });

            if (raceSelect) {
                raceSelect.addEventListener('change', applyFilter);
            }
            if (ageSelect) {
                ageSelect.addEventListener('change', applyFilter);
            }

            // √âtat initial : on masque tout tant que race et √¢ge ne sont pas choisis
            applyFilter();
        }


        // Initial state
        updateZones();
        initImageBank();
    
        // Gestion du t√©l√©chargement forc√© des images de la banque
        const dlLinks = document.querySelectorAll('.image-download');
        dlLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const url = this.getAttribute('href');
                const suggestedName = this.getAttribute('download') || url.split('/').pop() || 'image.png';

                // Tentative de t√©l√©chargement via fetch + blob
                try {
                    fetch(url)
                        .then(function(resp) { return resp.blob(); })
                        .then(function(blob) {
                            const blobUrl = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = blobUrl;
                            a.download = suggestedName;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                            URL.revokeObjectURL(blobUrl);
                        })
                        .catch(function() {
                            // Si fetch √©choue (par ex. ouverture locale), on retombe sur le lien normal
                            window.open(url, '_blank');
                        });
                } catch (err) {
                    window.open(url, '_blank');
                }
            });
        });

</script>
</body>
</html>
